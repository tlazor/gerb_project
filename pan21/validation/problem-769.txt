I'm running Shibby's Tomato firmware on my ASUS RT-N66U. What I'm trying to do is force OpenDNS IP's for certain clients (i.e. my kids) based on MAC address, while other clients get the router's default values. So far, so good (mostly). Here is the Dnsmasq script I'm using to do this:
Question #1: Is there a way to make this script apply to both 2.4Ghz (eth1) and 5Ghz (eth2)? Failing that, does Tomato allow me to whitelist devices for the 5Ghz band? I can whitelist/blacklist for wireless in general, but I don't see how to do this for one or the other.
Question #2: How can I force DNS for a particular client if they're not using DHCP? I was thinking some sort of Firewall rule only allowing DNS traffic to specific IP's for specific MAC addresses or something, but I have no idea how to go about that. Alternatively, is there any way to force DHCP (or block certain clients if they aren't using DHCP)?
I can always just use a different key for 5Ghz, so that's not a huge deal. The bigger loophole is that this only works with DHCP. Changing the DNS settings on the laptop completely bypasses this. My 12yo son is getting to the point that he could figure this out without much trouble.
This gets me pretty much what I wanted. The only thing lacking is that clients that don't match the first section (and so get the OpenDNS ip) don't have a secondary dns in case the first one is down. There's just no way to specify that using this method. Still, it works 99.99% of the time which is going to have to be good enough. Those last two lines for br1 ensure that anyone connecting to my guest network are forced to use OpenDNS as well.
This works great... on the 2.4Ghz band. If they connect to the 5Ghz band they get the router's default DNS entries.
For what it's worth, here's how I got this working (mostly). First, I made sure all the devices that I didn't want to use OpenDNS had hostnames. Next I added "home" as the Domain Name in Router Identification (it won't work without this). I then added the following firewall script: